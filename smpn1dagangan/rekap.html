<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Jurnal Mengajar Guru</title>
  <!-- Load Supabase Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 20px;
    }
    .minggu {
      margin-bottom: 60px;
      page-break-after: always;
    }
    .minggu:last-child {
      page-break-after: auto;
    }
    .minggu-header {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 30px;
      padding: 10px;
      background-color: #f0f0f0;
      border: 2px solid #000;
    }
    .hari {
      margin-bottom: 40px;
    }
    h3 {
      margin-bottom: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
      white-space: normal;
      word-break: break-word;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }

    /* Lebar Kolom */
    th:nth-child(1), td:nth-child(1) { width: 30px; }  /* No */
    th:nth-child(2), td:nth-child(2) { width: 50px; }  /* Kelas */
    th:nth-child(3), td:nth-child(3) { width: 50px; }  /* Hadir */
    th:nth-child(4), td:nth-child(4) { width: 50px; }  /* Tidak Hadir */
    th:nth-child(5), td:nth-child(5) { width: 120px; text-align: left; } /* Nama Siswa */
    
    /* Kolom isi (Kegiatan, Materi, Ket) */
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8) { 
      text-align: justify; 
    }

    /* Rangkuman dan TTD */
    .rangkuman {
      margin-top: 20px;
      width: 60%;
    }
    .tanda-tangan {
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .tanda-tangan div {
      text-align: center;
      width: 40%;
    }
    .tanda-tangan p {
      margin-top: 70px; /* Jarak untuk tanda tangan */
      margin-bottom: 0;
      border-bottom: 1px solid #000;
      display: inline-block;
      min-width: 150px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
    }

    /* Mode Print */
    @media print {
      .no-print { display: none !important; }
      body { margin: 10px; }
      @page { size: A4 portrait; margin: 15mm; }
      table, tr, td, th { page-break-inside: avoid !important; }
      .hari, .rangkuman, .tanda-tangan { page-break-inside: avoid !important; }
      .minggu { page-break-before: always; }
      .minggu:first-child { page-break-before: auto; }
    }
  </style>
</head>
<body>

<!-- Header dan Controls (Disembunyikan saat print) -->
<div class="no-print" style="margin-bottom: 30px; text-align: center; padding: 20px; background: #f9f9f9; border-bottom: 1px solid #ddd;">
  <div style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; flex-wrap: wrap;">
    <div>
      <label for="bulanSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Pilih Bulan:</label>
      <select id="bulanSelect" onchange="generateMonthlyJournal()" style="padding: 8px; font-size: 14px;">
        <option value="">-- Pilih Bulan --</option>
        <option value="1">Januari</option>
        <option value="2">Februari</option>
        <option value="3">Maret</option>
        <option value="4">April</option>
        <option value="5">Mei</option>
        <option value="6">Juni</option>
        <option value="7">Juli</option>
        <option value="8">Agustus</option>
        <option value="9">September</option>
        <option value="10">Oktober</option>
        <option value="11">November</option>
        <option value="12">Desember</option>
      </select>
    </div>
    <div>
      <label for="tahunSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Tahun:</label>
      <select id="tahunSelect" onchange="generateMonthlyJournal()" style="padding: 8px; font-size: 14px;">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
        <option value="2027">2027</option>
      </select>
    </div>
    <div>
      <button onclick="window.print()" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 5px;">
        ðŸ“„ Download PDF / Print
      </button>
    </div>
  </div>
</div>

<div id="jurnal-container"></div>

<script>
  // ==========================================
  // 1. SETUP SUPABASE
  // ==========================================
  
  // Cek apakah library Supabase berhasil dimuat
  if (typeof window.supabase === 'undefined') {
    document.body.innerHTML = '<h3 style="color:red; text-align:center;">Error: Library Supabase gagal dimuat. Cek koneksi internet Anda.</h3>';
    throw new Error("Supabase library not loaded");
  }

  const supabaseUrl = 'https://ztsckdzdqyfsdwmkoedq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0c2NrZHpkcXlmc2R3bWtvZWRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NTE5NjIsImV4cCI6MjA3NTIyNzk2Mn0.9gqhfVXGTKttiXrBX9rCZTp9uq-MhjDwNHq23R_ukjo';
  
  // Kita gunakan nama variabel 'supabaseClient' untuk menghindari bentrok nama
  const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

  // ==========================================
  // 2. VARIABEL GLOBAL & HELPER
  // ==========================================
  const hariList = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
  const bulanNama = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
  const container = document.getElementById("jurnal-container");
  let currentData = {};

  // Fungsi menyingkat nama siswa
  function buatInisial(namaList) {
    if (!namaList) return "-";
    return namaList.split(',').map(n => {
        n = n.trim();
        if(!n) return "";
        // Coba tangkap format: "Nama Lengkap 12 (S)" atau "Nama (I)"
        const match = n.match(/^(.+?)(\s+\d+)?\s*\(([^)]+)\)$/);
        if (match) {
            const nama = match[1].trim();
            const noAbsen = match[2] ? match[2].trim() : "";
            const status = match[3].trim().charAt(0).toUpperCase(); // I, S, A
            
            // Ambil inisial huruf depan tiap kata
            const inisial = nama.split(/\s+/).map(w => w[0].toUpperCase()).join('');
            return `${inisial}${noAbsen}(${status})`;
        }
        return n; // Kembalikan asli jika format beda
    }).filter(n => n).join(', ');
  }

  // Fungsi mendapatkan tanggal dalam seminggu
  function getWeekDates(year, month, weekNumber) {
    const firstDayOfMonth = new Date(year, month - 1, 1);
    let dayOfWeek = firstDayOfMonth.getDay(); 
    // Ubah Minggu(0) jadi 7 agar Senin(1) jadi awal
    if (dayOfWeek === 0) dayOfWeek = 7; 
    
    // Hitung tanggal Senin pertama di bulan/minggu tersebut
    // Rumus: Tgl 1 + (Week-1)*7 + (1 - HariKe)
    // Logika sederhana: Cari Senin pertama (tanggal 1 + offset), lalu tambah minggu
    
    // Offset untuk mencapai Senin pada minggu ke-1
    let startOffset = 1 - dayOfWeek; 
    if (dayOfWeek > 1) { 
        // Jika bulan mulai Selasa-Minggu, Senin minggu pertama sebenarnya ada di bulan lalu,
        // tapi kita biasanya menganggap "Minggu 1" adalah minggu yang mengandung tanggal 1.
        // Namun kode asli Anda logic-nya ingin 5 minggu fix.
        // Kita gunakan logika sederhana: 
        // Minggu 1 dimulai dari tanggal 1 (jika Senin) atau mundur ke Senin sebelumnya.
    }

    // Koreksi logika minggu agar sesuai kalender visual
    const firstMondayDate = new Date(year, month - 1, 1 + (1 - dayOfWeek)); 
    // Tapi jika tanggal 1 bukan senin, firstMondayDate bisa jadi bulan lalu. 
    // Ini oke untuk tampilan kalender mingguan.
    
    const weekStartDate = new Date(firstMondayDate);
    weekStartDate.setDate(firstMondayDate.getDate() + (weekNumber - 1) * 7);

    const dates = [];
    for (let i = 0; i < 5; i++) { // Senin s.d Jumat
      const d = new Date(weekStartDate);
      d.setDate(weekStartDate.getDate() + i);
      
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      dates.push(`${y}-${m}-${day}`);
    }
    return dates;
  }

  // Hitung Rangkuman Ijin/Sakit/Alpha
  function hitungRangkuman(weekDates) {
    let stats = { ijin: 0, sakit: 0, alpha: 0 };
    
    weekDates.forEach(date => {
      const list = currentData[date] || [];
      list.forEach(item => {
        if (item.nama_tidak_hadir) {
          const txt = item.nama_tidak_hadir.toLowerCase();
          stats.ijin += (txt.match(/\(ijin\)/g) || []).length;
          stats.sakit += (txt.match(/\(sakit\)/g) || []).length;
          stats.alpha += (txt.match(/\(alpha\)/g) || []).length;
        }
      });
    });
    return stats;
  }

  // ==========================================
  // 3. FUNGSI LOAD DATA
  // ==========================================
  async function loadJournalData(year, month) {
    // Ambil data user login
    const userRaw = localStorage.getItem('currentUser');
    if (!userRaw) {
      alert("Sesi habis. Silakan login kembali di Dashboard.");
      window.location.href = "dashboard.html";
      return;
    }
    const currentUser = JSON.parse(userRaw);

    // Query ke Supabase
    // Ambil data dari tanggal 1 bulan ini s.d tanggal 1 bulan depan
    const nextMonth = month === 12 ? 1 : month + 1;
    const nextYear = month === 12 ? year + 1 : year;
    
    const strStart = `${year}-${String(month).padStart(2,'0')}-01`;
    const strEnd = `${nextYear}-${String(nextMonth).padStart(2,'0')}-01`;

    const { data, error } = await supabaseClient
      .from('jurnal')
      .select('*')
      .eq('guru_id', currentUser.id)
      .gte('tanggal', strStart)
      .lt('tanggal', strEnd)
      .order('jam_awal', { ascending: true }); // Order by jam agar rapi

    if (error) {
      console.error("Supabase Error:", error);
      alert("Gagal mengambil data jurnal: " + error.message);
      return;
    }

    // Kelompokkan data berdasarkan tanggal untuk akses cepat
    currentData = {};
    if (data) {
      data.forEach(row => {
        if (!currentData[row.tanggal]) currentData[row.tanggal] = [];
        currentData[row.tanggal].push(row);
      });
    }
  }

  // ==========================================
  // 4. GENERATE HTML
  // ==========================================
  function generateWeeklyHTML(weekNum, year, month) {
    const dates = getWeekDates(year, month, weekNum);
    
    // Cek apakah minggu ini seluruhnya di luar bulan yang dipilih?
    // (Opsional: agar tidak mencetak minggu kosong di awal/akhir jika mau)
    
    let html = `<div class="minggu">`;
    // Header Minggu (Opsional, di desain Anda tidak ada header khusus per minggu selain pemisah halaman)
    
    hariList.forEach((namaHari, idx) => {
      const tgl = dates[idx]; // format YYYY-MM-DD
      const tglIndo = tgl.split('-').reverse().join('-'); // DD-MM-YYYY
      const dailyData = currentData[tgl] || [];

      html += `
        <div class="hari">
          <h3>Hari / Tanggal: ${namaHari}, ${tglIndo}</h3>
          <table>
            <thead>
              <tr>
                <th>No</th>
                <th>Kelas</th>
                <th>Hadir</th>
                <th>Absen</th>
                <th>Nama Siswa</th>
                <th>Kegiatan</th>
                <th>Materi</th>
                <th>Keterangan</th>
              </tr>
            </thead>
            <tbody>
      `;

      // Loop 11 Jam Pelajaran
      for (let jam = 1; jam <= 11; jam++) {
        // Cari data yang mencakup jam ini
        const entry = dailyData.find(d => jam >= d.jam_awal && jam <= d.jam_akhir);
        
        if (entry) {
            // Jika ini adalah jam awal, tampilkan datanya
            if (jam === entry.jam_awal) {
                // Hitung rowspan jika ingin menggabungkan sel (opsional, di sini kita pakai baris kosong untuk jam berikutnya)
                html += `
                  <tr>
                    <td>${jam}</td>
                    <td>${entry.kelas || '-'}</td>
                    <td>${entry.jumlah_hadir ?? '-'}</td>
                    <td>${entry.jumlah_tidak_hadir ?? '-'}</td>
                    <td>${buatInisial(entry.nama_tidak_hadir)}</td>
                    <td style="text-align:justify;">${entry.kegiatan || '-'}</td>
                    <td style="text-align:justify;">${entry.materi || '-'}</td>
                    <td style="text-align:justify;">${entry.keterangan || '-'}</td>
                  </tr>
                `;
            } else {
                // Jam ini tercover oleh jam sebelumnya (misal jam 2, padahal pelajaran jam 1-2)
                // Tampilkan baris strip "-"
                html += `<tr><td>${jam}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>`;
            }
        } else {
            // Kosong
            html += `<tr><td>${jam}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>`;
        }
      }

      html += `</tbody></table></div>`;

      // Jika Hari Jumat, Tambah Rangkuman
      if (namaHari === "Jumat") {
        const stats = hitungRangkuman(dates);
        html += `
          <table class="rangkuman">
            <thead>
              <tr><th colspan="3">Rangkuman Mingguan</th></tr>
              <tr><th>Ijin</th><th>Sakit</th><th>Alpha</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>${stats.ijin}</td>
                <td>${stats.sakit}</td>
                <td>${stats.alpha}</td>
              </tr>
            </tbody>
          </table>

          <div class="tanda-tangan">
            <div>
              <div style="margin-bottom:5px;">Mengetahui,</div>
              <div style="font-weight:bold;">Kepala Sekolah</div>
              <p></p> <!-- Garis TTD -->
              <div>NIP. ...........................</div>
            </div>
            <div>
              <div style="margin-bottom:5px;">..................., .......................</div>
              <div style="font-weight:bold;">Guru Mata Pelajaran</div>
              <p></p> <!-- Garis TTD -->
              <div>NIP. ...........................</div>
            </div>
          </div>
        `;
      }
    });

    html += `</div>`; // Tutup div.minggu
    return html;
  }

  // ==========================================
  // 5. FUNGSI UTAMA (Di-trigger oleh HTML)
  // ==========================================
  window.generateMonthlyJournal = async function() {
    const blnVal = document.getElementById("bulanSelect").value;
    const thnVal = document.getElementById("tahunSelect").value;

    if (!blnVal) return;

    const bulan = parseInt(blnVal);
    const tahun = parseInt(thnVal);

    container.innerHTML = '<div class="loading">Sedang mengambil data jurnal...</div>';

    try {
      await loadJournalData(tahun, bulan);
      
      container.innerHTML = ""; // Bersihkan loading
      
      // Generate 5 Minggu
      for (let i = 1; i <= 5; i++) {
        container.innerHTML += generateWeeklyHTML(i, tahun, bulan);
      }
      
    } catch (err) {
      console.error(err);
      container.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Terjadi kesalahan script: ${err.message}</div>`;
    }
  }

  // ==========================================
  // 6. AUTO RUN
  // ==========================================
  // Jika dropdown sudah terisi (misal refresh), jalankan langsung
  if (document.getElementById("bulanSelect").value) {
    generateMonthlyJournal();
  }

</script>
</body>
</html>